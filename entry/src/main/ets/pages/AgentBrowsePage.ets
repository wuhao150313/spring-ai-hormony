import { AgentVO } from '../models/AgentVO';
import router from '@ohos.router';

/**
 * æ™ºèƒ½ä½“æµè§ˆé¡µé¢
 */
@Component
export struct AgentBrowsePage {
  @State selectedCategory: string = 'ç²¾é€‰';
  @State agents: AgentVO[] = [];
  @State searchText: string = '';
  @State filteredAgents: AgentVO[] = [];
  categories: string[] = ['ç²¾é€‰', 'æ‹ç…§é—®', 'å­¦ä¹ ', 'ä¼ä¸š', 'å¤´åƒç”Ÿæˆ'];

  aboutToAppear() {
    this.loadAgents();
    this.filterAgents();
  }

  /**
   * è¿‡æ»¤æ™ºèƒ½ä½“åˆ—è¡¨
   */
  filterAgents() {
    if (!this.searchText || this.searchText.trim() === '') {
      this.filteredAgents = this.agents;
    } else {
      const searchKeyword = this.searchText.trim().toLowerCase();
      this.filteredAgents = this.agents.filter((agent: AgentVO) => {
        return agent.name.toLowerCase().includes(searchKeyword);
      });
    }
  }

  /**
   * åŠ è½½æ™ºèƒ½ä½“åˆ—è¡¨ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
   */
  loadAgents() {
    // æ¨¡æ‹Ÿæ•°æ®ï¼Œå®žé™…åº”è¯¥ä»ŽåŽç«¯èŽ·å–
    this.agents = [
      {
        id: 1,
        name: 'çŸ¥è¯†è®²è§£åŠ©æ‰‹',
        description: 'çŸ¥è¯†è®²è§£',
        icon: 'ðŸ’¡',
        isOfficial: true,
        chatCount: 10074000,
        author: '@è±†åŒ…å®˜æ–¹',
        category: 'ç²¾é€‰',
        isAdded: false
      },
      {
        id: 2,
        name: 'é”™é¢˜åˆ†æžåŠ©æ‰‹',
        description: 'é”™é¢˜åˆ†æž',
        icon: 'âœ…',
        isOfficial: true,
        chatCount: 3122000,
        author: '@è±†åŒ…å®˜æ–¹',
        category: 'å­¦ä¹ ',
        isAdded: false
      },
      {
        id: 3,
        name: 'å­¦ä¹ è®¡åˆ’åŠ©æ‰‹',
        description: 'å­¦ä¹ è®¡åˆ’',
        icon: 'ðŸ“…',
        isOfficial: true,
        chatCount: 585000,
        author: '@è±†åŒ…å®˜æ–¹',
        category: 'å­¦ä¹ ',
        isAdded: false
      },
      {
        id: 4,
        name: 'è¯¾è¡¨æŸ¥è¯¢åŠ©æ‰‹',
        description: 'è¯¾è¡¨æŸ¥è¯¢',
        icon: 'ðŸ“†',
        isOfficial: true,
        chatCount: 10270000,
        author: '@è±†åŒ…å®˜æ–¹',
        category: 'å­¦ä¹ ',
        isAdded: false
      },
      {
        id: 5,
        name: 'å›¾ä¹¦é¦†æŸ¥è¯¢åŠ©æ‰‹',
        description: 'å›¾ä¹¦é¦†å€Ÿé˜…æŸ¥è¯¢',
        icon: 'ðŸ“–',
        isOfficial: true,
        chatCount: 11744000,
        author: '@è±†åŒ…å®˜æ–¹',
        category: 'ç²¾é€‰',
        isAdded: false
      },
      {
        id: 6,
        name: 'å¤©æ°”æŸ¥è¯¢åŠ©æ‰‹',
        description: 'å¤©æ°”æŸ¥è¯¢',
        icon: 'â˜€ï¸',
        isOfficial: true,
        chatCount: 5000000,
        author: '@è±†åŒ…å®˜æ–¹',
        category: 'ç²¾é€‰',
        isAdded: false
      },
      {
        id: 7,
        name: 'é€šç”¨æŸ¥è¯¢åŠ©æ‰‹',
        description: 'æŸ¥è¯¢',
        icon: 'ðŸ”',
        isOfficial: true,
        chatCount: 3500000,
        author: '@è±†åŒ…å®˜æ–¹',
        category: 'ç²¾é€‰',
        isAdded: false
      },
      {
        id: 8,
        name: 'ä¿ä¿®æäº¤åŠ©æ‰‹',
        description: 'ä¿ä¿®æäº¤',
        icon: 'ðŸ› ï¸',
        isOfficial: true,
        chatCount: 2800000,
        author: '@è±†åŒ…å®˜æ–¹',
        category: 'ç²¾é€‰',
        isAdded: false
      },
      {
        id: 9,
        name: 'åŠ©å­¦æ”¿ç­–åŠ©æ‰‹',
        description: 'åŠ©å­¦æ”¿ç­–',
        icon: 'ðŸ“‹',
        isOfficial: true,
        chatCount: 4200000,
        author: '@è±†åŒ…å®˜æ–¹',
        category: 'ç²¾é€‰',
        isAdded: false
      }
    ];
  }

  /**
   * æ ¼å¼åŒ–èŠå¤©äººæ•°
   */
  formatChatCount(count: number): string {
    if (count >= 10000) {
      return `${(count / 10000).toFixed(1)}ä¸‡äººèŠè¿‡`;
    }
    return `${count}äººèŠè¿‡`;
  }

  /**
   * åˆ‡æ¢åˆ†ç±»
   */
  switchCategory(category: string) {
    this.selectedCategory = category;
    // è¿™é‡Œå¯ä»¥æ ¹æ®åˆ†ç±»ç­›é€‰æ™ºèƒ½ä½“
  }

  /**
   * æ·»åŠ /ç§»é™¤æ™ºèƒ½ä½“
   */
  toggleAgent(agent: AgentVO) {
    agent.isAdded = !agent.isAdded;
    // è¿™é‡Œå¯ä»¥è°ƒç”¨åŽç«¯APIä¿å­˜çŠ¶æ€
  }

  /**
   * å¤„ç†æ™ºèƒ½ä½“ç‚¹å‡»äº‹ä»¶
   */
  onAgentClick(agent: AgentVO) {
    // è·³è½¬åˆ°æ™ºèƒ½ä½“å¯¹è¯é¡µé¢
    router.pushUrl({
      url: 'pages/AgentChatPage',
      params: {
        agentId: agent.id,
        agentName: agent.name
      }
    }).catch((err: Error) => {
      console.error('Failed to navigate to AgentChatPage:', JSON.stringify(err));
    });
  }

  build() {
    Column() {
      // æœç´¢æ¡†
      TextInput({ placeholder: 'æœç´¢æ™ºèƒ½ä½“...', text: this.searchText })
        .width('100%')
        .height(44)
        .backgroundColor('#FFFFFF')
        .padding({ left: 16, right: 16 })
        .margin({ top: 8, bottom: 8, left: 16, right: 16 })
        .borderRadius(22)
        .onChange((value: string) => {
          this.searchText = value;
          this.filterAgents();
        });

      // æ™ºèƒ½ä½“åˆ—è¡¨
      List() {
        ForEach(this.filteredAgents, (agent: AgentVO) => {
          ListItem() {
            Row() {
              // å›¾æ ‡
              Text(agent.icon)
                .fontSize(40)
                .width(60)
                .height(60)
                .textAlign(TextAlign.Center)
                .backgroundColor('#F5F5F5')
                .borderRadius(30);

              // å†…å®¹åŒºåŸŸ
              Column() {
                Row() {
                  Text(agent.name)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#333333');
                  
                  if (agent.isOfficial) {
                    Text('å®˜æ–¹')
                      .fontSize(10)
                      .fontColor('#007AFF')
                      .backgroundColor('#E6F0FF')
                      .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                      .borderRadius(4)
                      .margin({ left: 8 });
                  }
                }
                .width('100%')
                .alignItems(VerticalAlign.Center);

                Text(agent.description)
                  .fontSize(14)
                  .fontColor('#666666')
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .margin({ top: 4 })
                  .width('100%');

                Row() {
                  Text(this.formatChatCount(agent.chatCount))
                    .fontSize(12)
                    .fontColor('#999999');
                  
                  Text(agent.author)
                    .fontSize(12)
                    .fontColor('#999999')
                    .margin({ left: 8 });
                }
                .width('100%')
                .margin({ top: 4 });
              }
              .layoutWeight(1)
              .margin({ left: 12 });
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 12, bottom: 12 })
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
            .margin({ left: 16, right: 16, top: 8, bottom: 8 })
            .onClick(() => {
              this.onAgentClick(agent);
            });
          }
        }, (agent: AgentVO) => agent.id.toString());
      }
      .layoutWeight(1)
      .padding({ top: 8, bottom: 8 })
      .backgroundColor('#F5F5F5');
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5');
  }
}


import { AuthService } from '../services/AuthService';
import { UserInfoVO } from '../models/UserInfoVO';
import { StorageUtil } from '../utils/StorageUtil';
import { ResultUtil } from '../models/Result';
import router from '@ohos.router';

/**
 * ç”¨æˆ·ä¸­å¿ƒé¡µé¢
 */
@Component
export struct UserCenterPage {
  @State isLoggedIn: boolean = false;
  @State userInfo: UserInfoVO | null = null;
  @State isLoading: boolean = false;
  @StorageLink('refreshUserCenter') refreshTrigger: number = 0;
  lastRefreshTrigger: number = 0;

  async aboutToAppear() {
    // åˆå§‹åŒ– AppStorage é”®
    if (!AppStorage.has('refreshUserCenter')) {
      AppStorage.setOrCreate('refreshUserCenter', 0);
    }
    this.lastRefreshTrigger = this.refreshTrigger;
    await this.checkLoginStatus();
  }

  aboutToUpdate() {
    // ç›‘å¬ refreshTrigger å˜åŒ–ï¼Œåˆ·æ–°ç™»å½•çŠ¶æ€
    if (this.refreshTrigger !== this.lastRefreshTrigger && this.refreshTrigger !== 0) {
      this.lastRefreshTrigger = this.refreshTrigger;
      this.checkLoginStatus();
    }
  }

  /**
   * æ£€æŸ¥ç™»å½•çŠ¶æ€
   */
  async checkLoginStatus() {
    this.isLoading = true;
    try {
      const loggedIn = await AuthService.isLoggedIn();
      this.isLoggedIn = loggedIn;
      if (loggedIn) {
        // å…ˆä»æœ¬åœ°åŠ è½½ç”¨æˆ·ä¿¡æ¯
        const localUserInfo = await StorageUtil.getUserInfo();
        if (localUserInfo) {
          this.userInfo = localUserInfo;
        }
        
        // å†ä»åç«¯è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯èƒ½ä¼šè¦†ç›–æœ¬åœ°ï¼‰
        try {
          const result = await AuthService.getCurrentUserInfo();
          if (ResultUtil.isSuccess(result) && result.data) {
            this.userInfo = result.data;
            // ä¿å­˜åˆ°æœ¬åœ°
            await StorageUtil.saveUserInfo(result.data);
          }
        } catch (err) {
          console.warn('[UserCenterPage] è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', JSON.stringify(err));
        }
      } else {
        // æœªç™»å½•ï¼Œæ¸…ç©ºç”¨æˆ·ä¿¡æ¯
        this.userInfo = null;
      }
    } catch (err) {
      console.error('[UserCenterPage] æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', err);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * è·³è½¬åˆ°ç™»å½•é¡µ
   */
  navigateToLogin() {
    router.pushUrl({
      url: 'pages/LoginPage'
    }).then(() => {
      // ç™»å½•é¡µé¢è¿”å›ååˆ·æ–°çŠ¶æ€
    }).catch((err: Error) => {
      console.error('Failed to navigate:', JSON.stringify(err));
    });
  }

  /**
   * é€€å‡ºç™»å½•
   */
  async handleLogout() {
    try {
      await AuthService.logout();
      this.isLoggedIn = false;
      this.userInfo = null;
    } catch (err) {
      console.error('[UserCenterPage] é€€å‡ºç™»å½•å¤±è´¥:', err);
    }
  }

  /**
   * ç¼–è¾‘ä¸ªäººèµ„æ–™
   */
  editProfile() {
    // TODO: è·³è½¬åˆ°ç¼–è¾‘èµ„æ–™é¡µé¢
  }

  build() {
    Column() {
      if (this.isLoading) {
        LoadingProgress()
          .width(40)
          .height(40)
          .color('#007AFF')
          .margin({ top: 100 });
      } else if (!this.isLoggedIn) {
        // æœªç™»å½•çŠ¶æ€
        Column() {
          // å¤´åƒå ä½
          Text('ğŸ‘¤')
            .fontSize(60)
            .width(80)
            .height(80)
            .textAlign(TextAlign.Center)
            .backgroundColor('#E6F0FF')
            .borderRadius(40)
            .margin({ top: 60, bottom: 16 });

          Text('ç‚¹å‡»ç™»å½•')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .margin({ bottom: 8 })
            .onClick(() => {
              this.navigateToLogin();
            });

          Button('ç™»å½•')
            .width(200)
            .height(44)
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#007AFF')
            .borderRadius(22)
            .onClick(() => {
              this.navigateToLogin();
            });
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center);
      } else {
        // å·²ç™»å½•çŠ¶æ€
        Column() {
          Scroll() {
            Column() {
              // ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
              Column() {
                // å¤´åƒ
                if (this.userInfo?.avatar && this.userInfo.avatar.trim() !== '') {
                  Image(this.userInfo.avatar)
                    .width(100)
                    .height(100)
                    .borderRadius(50)
                    .objectFit(ImageFit.Cover)
                    .margin({ top: 20, bottom: 16 })
                    .alt('å¤´åƒ')
                    .onError(() => {
                      console.error('[UserCenterPage] å¤´åƒåŠ è½½å¤±è´¥:', this.userInfo?.avatar);
                    });
                } else {
                  Text('ğŸ‘¤')
                    .fontSize(80)
                    .width(100)
                    .height(100)
                    .textAlign(TextAlign.Center)
                    .backgroundColor('#E6F0FF')
                    .borderRadius(50)
                    .margin({ top: 20, bottom: 16 });
                }

                // ç”¨æˆ·åï¼ˆä¼˜å…ˆæ˜¾ç¤ºæ˜µç§°ï¼Œå…¶æ¬¡ç”¨æˆ·åï¼‰
                Text(this.userInfo?.nickname || this.userInfo?.username || 'ç”¨æˆ·')
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333333')
                  .margin({ bottom: 8 });

                // ç”¨æˆ·åï¼ˆ@æ ¼å¼ï¼‰
                Text(`@${this.userInfo?.username || 'ç”¨æˆ·'}`)
                  .fontSize(14)
                  .fontColor('#999999')
                  .margin({ bottom: 16 });

                // ç¼–è¾‘ä¸ªäººèµ„æ–™æŒ‰é’®
                Button('ç¼–è¾‘ä¸ªäººèµ„æ–™')
                  .width(200)
                  .height(36)
                  .fontSize(14)
                  .fontColor('#333333')
                  .backgroundColor('#F5F5F5')
                  .borderRadius(18)
                  .onClick(() => {
                    this.editProfile();
                  });
              }
              .width('100%')
              .padding({ top: 20, bottom: 20 })
              .backgroundColor('#FFFFFF')
              .alignItems(HorizontalAlign.Center);

              // é€€å‡ºç™»å½•æŒ‰é’®
              Button('é€€å‡ºç™»å½•')
                .width('90%')
                .height(44)
                .fontSize(16)
                .fontColor('#FF3B30')
                .backgroundColor('#FFFFFF')
                .borderRadius(22)
                .margin({ top: 20, bottom: 20 })
                .onClick(() => {
                  this.handleLogout();
                });
            }
            .width('100%')
          }
          .layoutWeight(1)
          .width('100%')
          .backgroundColor('#F5F5F5');
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor('#F5F5F5');
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5');
  }

  /**
   * é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°çŠ¶æ€
   */
  onPageShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
    this.checkLoginStatus();
  }
}

